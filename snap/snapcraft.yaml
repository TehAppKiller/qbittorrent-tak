name: qbittorrent-tak
summary: UnOfficial release of qBittorrent
description: |
  **qBittorrent is a free and open-source BitTorrent client** based on the Qt toolkit and libtorrent-rasterbar library.

  * The web interface is accessible by default at http://localhost:8080
  * See https://www.qbittorrent.org for more details.

  **qBittorrent Release 4+**
  * Service is restarted on any condition.

  **Post install commands required to access media folders and see default password :**

  sudo snap connect qbittorrent-tak:removable-media

  sudo snap logs qbittorrent-tak
website: https://www.qbittorrent.org
source-code: https://github.com/TehAppKiller/qbittorrent-tak
issues: https://github.com/TehAppKiller/qbittorrent-tak/issues
license: MIT
icon: icon.svg
grade: stable
confinement: strict
base: core24
adopt-info: qbittorrent

apps:
  qbittorrent:
    command: bin/run-qbittorrent.sh
    daemon: simple
    restart-condition: always
    plugs:
      - network
      - network-bind
      - removable-media
    environment:
      LD_LIBRARY_PATH: $LD_LIBRARY_PATH:$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libproxy
      QT_PLUGIN_PATH: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/qt6/plugins
      XDG_DATA_DIRS: $SNAP/usr/share

parts:
  qbittorrent:
    override-pull: |
      craftctl default

      # Get Last Source Tag version and Check Snap (with same Source) version
      src_version=$(git ls-remote --tags https://github.com/qbittorrent/qBittorrent.git | grep 'release\-[0-9]*\.[0-9]*\.[0-9]*\^' | tail -n 1 | sed 's/.*\/release-//; s/\^{}//');
      echo "qBittorrent source last tag: ${src_version}"
      snap_last_version=$(curl -sL --unix-socket /run/snapd.socket http://localhost/v2/find\?q\=qbittorrent-tak | sed -nre "s/^.*\"version\"\:\"([^\"]*)\".*/\1/p");
      echo "snap last version: ${snap_last_version}"
      snap_build_with_same_version=$(echo $snap_last_version | sed -nre "s/^($src_version.*).*/\1/p");
      # Same version ?
      if [ -z "$snap_build_with_same_version" ]
      then
        new_snap_version="${src_version}";
      else
        # Get snap build version
        snap_build=$(echo $snap_build_with_same_version | sed -nre 's/^.*-v([0-9]*).*/\1/p');
        # Already a build version ?
        if [ -z "$snap_build" ]
        then
          # init @v2
          new_snap_build="2";
        else
          # increment @v+1
          new_snap_build=$(($snap_build+1));
        fi

        new_snap_version="${src_version}-v${new_snap_build}";
      fi

      craftctl set version=$new_snap_version

      # Pull
      cd $CRAFT_PART_SRC
      rm -r *
      wget "https://github.com/qbittorrent/qBittorrent/archive/refs/tags/release-${src_version}.tar.gz"
      tar xvf "release-${src_version}.tar.gz"
      cd "qBittorrent-release-${src_version}"
      mv * $CRAFT_PART_SRC
      cd ..
      rm "release-${src_version}.tar.gz"
      rm -r "qBittorrent-release-${src_version}"
    source: .
    plugin: cmake
    cmake-generator: Ninja
    cmake-parameters:
      - -DCMAKE_INSTALL_PREFIX=/usr
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DGUI=OFF
      - -DQT6=ON
    build-packages:
      - git
      - wget
      - build-essential
      - pkg-config
      - automake
      - libtool
      - zlib1g-dev
      - libssl-dev
      - libgeoip-dev
      - libboost-dev
      - libboost-system-dev
      - libboost-chrono-dev
      - libboost-random-dev
      - libtorrent-rasterbar-dev
      - qt6-base-dev
      - qt6-base-private-dev
      - qt6-tools-dev
    override-build: |
      ls
      ls $CRAFT_PART_SRC
      craftctl default
    override-prime: |
      craftctl default
      export XDG_DATA_DIRS=usr/share
      update-mime-database usr/share/mime
    prime:
      - usr/bin/qbittorrent-nox

  local:
    plugin: dump
    source: snap/local

  deps:
    plugin: nil
    source: .
    stage-packages:
      - shared-mime-info
      - libqt6core6t64
      - libqt6network6t64
      - libqt6sql6t64
      - libqt6xml6t64
      - libb2-1
      - libcurl3t64-gnutls
      - libdouble-conversion3
      - libgomp1
      - libldap2
      - libnghttp2-14
      - libpcre2-16-0
      - libproxy1v5
      - libpsl5t64
      - librtmp1
      - libsasl2-2
      - libssh-4
      - libtorrent-rasterbar2.0t64
